---
layout: post
title: "NAT와 DHCP"
categories: 네트워크
author: bn-tw2020
---
* content
{:toc}


## NAT

* 인터넷 상에서 데이터를 주고 받기 위해선 고유한 IP주소를 가지고 있어야 합니다.

  하지만 현재 IP주소가 많이 부족합니다. 그래서 NAT 방식을 이용합니다.

* NAT(Network Address Translation)은 네트워크 자원 절약 및 보안 강화를 위해 사용하는 IP 주소 변환 기술입니다.

* IP를 매핑하기 위해 NAT 테이블을 구성합니다.

* NAT는 정해진 개수 만큼 공인 IP주소를 가지고 순차적 사설IP주소를 매핑하거나, 1:1, 1:N 혹은 별도의 포트를 이용합니다.



## NAT 목적

* IP 자원 부족에 따른 IP공유

  외부와 통신하기 위한 공인 IP 부족 시 공인 IP를 공유하여 외부와 통신합니다.

* 내부 네트워크 보호

  내부 네트워크를 외부로부터 보호하고자 IP주소 등 정보 은폐 시 사용합니다.



## DHCP

* 지금 바로 컴퓨터를 켜서 ip주소를 확인하기 위해서 ipconfig ifconfig을 치게되면 ip, mask, router, dns의 정보가 나타나게 될 것이다.

  이 정보는 내가 작성한것인가? 아니다.

  그럼 누가 작성한 것인가? **DHCP(Dynamic Host Configuration Protocol)** 이다

  카페가서 다시 ipconfig, ifconfig을 치고 확인해보면 더 다른 정보로 바껴있을 것이다.

  말 그대로, 어딜 가든지 동적으로 호스트를 설정해주는 프로토콜이다.

* 학교에 입학했을 때 고정IP를 쓰게 된다면 학번과 고정IP를 줄 것이다. 만약 학생이 만 명이라면 고정 IP가 만 개가 필요할 것이다.

  하지만, 동적으로 한다고하면 만 개는 반드시 필요 없을 것이다. 그래서 IP를 빌려주고 회수하는 과정을 거치게 될 것이다.

<img width="456" alt="스크린샷 2021-08-27 오전 2 17 20" src="https://user-images.githubusercontent.com/66770613/131006968-80edfb4f-99aa-407f-8312-16680a5e265b.png">  

```
1. 처음 네트워크에 들어오게되면 아무런 정보를 가지고 있지 않다.

2. (DHCP 검색) 
   소스 주소는 0.0.0.0이다. 나는 무명이다. 68번에 클라이언트에 돌리고 있겠다.
   목적지는 255.255.255.255이다. => 브로드캐스트이다(서브넷에 있는 모든 멤버들은 이 메시지를 받아라~)
   목적지 포트는 67이다.

3. DHCP만 브로드캐스트를 받아 들이고, 나머지는 반응하지 않는다. 반응하지 않는 원리는 DHCP만 67번 포트를 열고 나머지는 안열려있기 때문이다.
   그래서, 물리, 데이터링크, 네트워크 계층, 전송 계층을 거쳐 포트가 안열려있어서 버리게되는 것입니다.

4. (DHCP 제공) 
  DHCP는 자신의 IP주소와 포트 번호를 소스 주소로 하게되고, 
   목적지를 브로드캐스트로 전송받은 포트 68번와 트랜잭션ID를 통해 들어온 클라이언트에게 보내게됩니다.
   보낼 때 사용가능한 주소(yiaddrr)와 사용시간을 보냅니다.
   여기서, 68번은 새로 들어온 클라이언트만 포트로 열려있기 때문에 의미있게 새로 들어온 클라이언트만 받게 됩니다.

5. (DHCP 요청)
   클라이언트는 DHCP에게 사용하고 싶다고 요청을 보냅니다. 이 과정에서 DHCP의 주소를 알고 있음에도 브로드캐스트를 보내는 이유는 DHCP가 여러 개 있을 수도 있기 떄문에 모두에게 알려주는 것입니다.

6. (DHCP 승인 or 부정)
   DHCP는 DHCP ACK 패킷을 브로드 캐스트합니다.
```

## 기타

<img width="655" alt="스크린샷 2021-08-27 오전 12 22 20" src="https://user-images.githubusercontent.com/66770613/130990534-4a10747b-f7d1-4c79-8582-8034989ea27c.png">  

* 헤더에 id, flags, offset이 존재한다.

* 패킷을 생성했는데 패킷의 크기가 4000byte였다고 가정해보자. 

  각 링크별로 한번에 보낼 수 있는 사이즈가 존재하는데 그 사이즈는 MTU라고 부릅니다.

  MTU는 와이파이, 이더넷, 광케이블 등 매체에 따라 달라집니다.

  특정 링크에서 MTU 1500byte이면 갈수가 없게 됩니다. 드랍을 시키는 방법이 있지만, 그곳에서 바로 분리를 하게됩니다.

<img width="481" alt="스크린샷 2021-08-27 오전 2 54 01" src="https://user-images.githubusercontent.com/66770613/131011978-c4cacaa2-aab9-4eff-a074-4c4238fcb3f8.png">  

<img width="804" alt="스크린샷 2021-08-27 오전 2 58 15" src="https://user-images.githubusercontent.com/66770613/131012574-51591ed7-db34-4f8e-ab51-2dae08463b67.png">  


* 만약 분리되었는데... 하나가 없어졌다면?

  reassembly가 안되면 패킷이 완성되지 않은 것이기 때문에 애플리케이션 계층까지 올라갈 수 없다.

  결국 나중에 타이머가 걸리고 TCP계층에서 재전송을 해줄 것이다.

## Reference

[NAT 그림과 글로 배우기](https://run-it.tistory.com/24)
[DHCP](https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&blogId=youandi0442&logNo=80124239899)