---
layout: post
title: "Trigger"
categories: DB
author: bn-tw2020
---
* content
{:toc}

## Intro

```
트리거와 구성 및 구현에 대한 설명을 하는 글입니다.
```


## 트리거의 개요

데이터베이스 시스템에서 데이터의 삽입, 갱신, 삭제 등의 이벤트가 발생할 때 관련 작업이 자동으로 수행되는 절차형 SQL

```
1. 트리거는 데이터베이스에 저장된다.
2. 데이터 변경 및 무결성 유지, 로그 메시지 출력 등의 목적으로 사용한다.
   무결성 : 데이터베이스에 들어있는 데이터의 정확성을 보장하기 위해서 정확하지 않은 데이터가 데이터베이스 내에 저장되는 것을 방지하기 위한 제약 조건
3. 트리거 구문에서는 DCL을 사용할 수 없으며, DCL이 포함된 프로시저나 함수를 호출하는 경우에 오류가 발생
4. 트리거에 오류가 있는 경우
   트리거가 처리하는 데이터에도 영향을 미치므로 트리거를 생성할 때 섬세함이 필요
```




## 트리거의 구성

* 트리거는 `선언` `이벤트` `시작` `종료`로 구성

* 시작과 종료 구문 사이에는 제어(CONTROL), SQL, 예외(EXCEPTION)이 포함된다.

```
DECLARE(필수)
EVENT(필수)
BEGIN(필수)
    • CONTROL
    • SQL
    • EXCEPTION
END(필수)
```

```
1. DECLARE
   트리거의 명칭, 변수 및 상수, 데이터 타입을 정의하는 선언부

2. EVENT
   트리거가 실행되는 조건을 명시

3. BEGIN / END
   트리거의 시작과 종료를 의미

4. CONTROL
   조건문 또는 반복문이 삽입되어 순차적으로 처리한다.

5. SQL
   DML문이 삽이되어 데이터 관리를 위한 조회, 수정, 추가, 삭제 작업을 수행

6. EXCEPTION
   BEGIN ~ END 안의 구문 실행 시 예외가 발생하면 이를 처리하는 방법을 정의
```

## 트리거의 생성

* 트리거를 생성하기 위해서는 CREATE TRIGGER 명령어를 사용한다.

```
CREATE [OR REPLACE] TRIGGER 트리거명 동작시기 동작 ON 테이블명
[REFERENCING NEW | OLD AS 테이블 명]
[FOR EACH ROW [WHEN 조건식]]
BEGIN
   트리거 BODY;
END;
```

```
1. OR REPLACE
   선택적인 예약어로, 동일한 트리거명이 존재하는 경우, 덮어쓰기가 가능하다.

2. 동작 시기
   트리거가 실행될 때를 지정하며, AFTER와 BEFORE가 존재
   AFTER : 테이블이 변경된 후에 트리거가 실행
   BEFORE : 테이블이 변경되기 전에 트리거가 실행

3. 동작
   트리거가 실행되게 할 작업의 종류를 지정하며, INSERT, DELETE, UPDATE가 존재
   INSERT : 테이블에 새로운 튜플이 삽입할 때 트리거가 실행 
   DELETE : 테이블의 튜플을 삭제할 때 트리거가 실행
   UPDATE : 테이블의 튜플을 수정할 때 트리거가 실행

4. NEW | OLD
   트리거가 적용될 테이블의 별칭을 지정
   NEW : 추가되거나 수정에 참여할 튜플들의 테이블을 의미한다.
   OLD : 수정되거나 삭제 전 대상이 되는 튜플들의 테이블을 의미한다.

5. FOR EACH ROW
   각 튜플마다 트리거를 적용한다는 의미

6. WHEN 조건식
   선택적인 예약어이며, 트리거를 적용할 튜플의 조건을 지정

7. 트리거 BODY
   트리거의 본문 코드를 입력하는 부분
   BEGIN ~ END로 끝나며, 적어도 하나 이상의 SQL문이 필요하며, 그렇지 않으며 오류가 발생
```


```
Example

Q. <학생> 테이블에 새로운 튜플이 삽입될 때, 삽입되는 튜플에 학년 정보가 누락됐으면 
   '학년' 필드에 '신입생'을 치환하는 트리거를 '학년정보_tri'라는 이름으로 정의하는 트리거를 작성해라.

CREATE TRIGGER 학년정보_tri BEFORE INSERT ON 학생
REFERENCING NEW AS new_table
FOR EACH ROW
WHEN (new_table.학년 IS NULL)
   BEGIN
     :new_table.학년 := '신입생';
   END;

차례대로 해석을 해보면,
1. <학생> 테이블에 튜플을 삽입하기 전에 동작하는 트리거 '학년정보_tri'를 생성
2. 새로 추가될 튜플들의 집합 NEW의 별칭을 <new_table>로 명명한다.
3. 모든 튜플을 대상으로 한다.
4. <new_table>에서 '학년' 속성이 NULL인 튜플에 '학년정보_tri'가 적용된다.
5. <new_table>의 '학년' 속성에 '신입생'을 치환한다.
   2번에서 NEW 또는 OLD로 지정된 테이블 이름 앞에는 클론(:)이 들어간다.
   A := B에서 A에 B를 치환하라는 의미로, '='가 아니라 ':='를 사용한다.
```

## 트리거의 제거

* 트리거를 제거하기 위해서는 DROP TRIGGER 명령어를 사용한다.

```
DROP TRIGGER 트리거 명;

```

```
Example

Q. '학년정보_tri'라는 트리거를 제거하는 SQL문을 작성하시오.

DROP TRIGGER 학년정보_tri;
```

## Summary

* 트리거는 데이터베이스 시스템에서 데이터의 삽입, 갱신, 삭제 등의 이벤트가 발생할 때 관련 작업이 자동으로 수행되는 절차형 SQL

* 위의 트리거 예제는 Oracle로 작성된 프로시저이며, DBMS마다 상이하다.