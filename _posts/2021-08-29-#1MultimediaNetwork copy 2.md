---
layout: post
title: "멀티 미디어 네트워크"
categories: 네트워크
author: bn-tw2020
---
* content
{:toc}


## 멀티 미디어 네트워킹

* 어떻게 유튜브 같은 멀티미디어가 동작할까?





## 개요

* 오디오, 음성는 결국 아날로그 신호이다.

  아날로그를 정형화된 디지털 값으로 변환해서 전송할 수 있다. 이 과정이 샘플링이라는 과정을 거친다.

  어떤 값이 얼마나 디지털 시켜서 얼마다라고 설정하게되면 오차가 발생한다.

  아날로그 값을 디지털 값으로 바꿀 때 비트의 수가 크면 클수록 에러가 줄어든다.

  아날로그 값을 완벽하게 복원하기 위해선 샘플링의 크기와 샘플링의 주기를 많이하면된다.

  즉, 초당 얼마나 비트로 가지고 표현하는가에 따라 음성에 음질이 달라진다.

* 우리가 알고 있는 MP3 오디오 파일을 보게 되면, 96, 128 160 kbps가 있고, CD는 1,411Mbps이다.

  그래서 CD가 훨씬 음질이 좋다.

* 비디오는 이미지의 연속이다.

  초당 이미지 몇개를 연속이 되면 영상처럼 느껴진다. 각 이미지는 프레임으로 표현한다.

  프레임을 디지털을 전환시킬 때 각 픽셀의 색상 값이 나타내는가를 저장하는 것이다.

  주변 값이 중복 될 값을 쭉 적는 것보다 압축해서 보내게 될 수 있는 것이다.

  즉, 픽셀 단위로 압축시키는 것이다.


## 멀티미디어 네트워크

* 위와 같은 멀티미디어 파일을 주된 데이터로 해서 주고 받는 애플리케이션으로 3가지를 생각할 수 있다.

* streaming stored audio, video; 멀티미디어 데이터인데 이미 서버에 저장이 되어 있고 클라이언트에서 쭉 보내주는 것이다. youtube와 같은 것들이다.

* conversational : voice/video over IP를 의미한다.

* streaing live ; 서버에 저장되는게 아니라 실제 일어나는 일드을 실시간으로 받는 것이다. 야구 중계가 존재한다.


## streaming stored video

* 서버가 보내고, 네트워크를 거쳐서 클라이언트가 받는경우가 이상적인 현상이다.

  현실에서는 네트워크 딜레이에 따라서 달라진다. 첫 프레임을 받아서 실행시켯는데 두 번째 프레임은 더 늦게 받아서 기다려야 한다.

* 그래서 프레임을 받고 바로 실행시키는 것이 아닌 좀 기달렷다가 실행시켜서 연속적으로 보여지게 된다. 이것을 버퍼링이라 부른다.

  그럼 버퍼링이 길면 길수록 좋을까? 많이 받아놓고 보여줘서 않 끊기니깐?

  하지만 사람의 인내심과 끊키지 않는 어느정도 선에서 합의를 봐야한다.

* 프레임이 들어오는 속도보다 플레이어가 가져가는 속도가 더 빠르면 버퍼에 남아있는 것이 없게되어 영상이 멈춰버리는 현상이 발생한다.

  그러면 사용자 입장에서 짜증이 발생하게 된다. 그럼 사용자들은 그 서비스 업체를 사용하지 않을 것이다.

* 그래서 버퍼링을 없애기 위해서 채우는게 중요한 핵심이다!


## 네트워크 관점

* 유튜브와 클라이언트는 애플리케이션이다.

  애플리케이션 사이의 통신이기 때문에 전송 계층에 의존한다. 전송 계층은 TCP와 UDP가 존재한다.

  둘 중에 골라서 영상을 보내야한다.

* 동영상이 2Mbps로 인코딩한다고 하면, 보내는 속도는 2Mbps보다 빨라야 원할하게 스트리밍이 가능하다.

* TCP와 UDP 둘중 무엇을 선택해야 하나?

  영상이 2Mbps로 인코딩된다는 것은 보내는 속도는 그것 이상이 되어야 한다.

  UDP는 전송 속도는 내가 정한다. 그래서 유리하다

  TCP의 전송 속도는 네트워크가 정한다. 그래서 들쑥 날쑥하다.그래서 문제가 발생한다.

* 여기서 문제는 중간에 네트워크의 상황이 안좋아서 2kbps정도의 속도만 받아들일 수 있다면  

  UDP가 2Mbps로 보내도 사용자 입장에선 2kbps로 받아서 열이 받는다.

  그러면 TCP를 쓰자 네트워크 상황에는 적응하는데 2Mbps 이상의 속도로 못낼수가 있다.

> 도대체 뭘 쓰길래 우리가 만족하길래 쓰고 있을까?

* 유튜브는 TCP를 쓴다. 그런데 여기에 동적으로 애플리케이션 계층에서 처리를 해준다.

  보통 유튜브 같은 멀티미디어 서비스들은 DASH라는 애플리케이션 기술을 사용한다.

* DASH(Dynamic, Adaptive Streaming over HTTP); 스트리밍을 HTTP를 통해 보낸다.

  동적으로 네트워크에 알맞게 해준다.


## 과정

```
1. 유튜브에서 매트릭스라는 영화를 본다. 2시간 정도면 2GB파일이다.
2. 큰 영상 파일을 아주 작은 조각 단위인 chunks로 나눈다. 대략 256kb 정도가 된다. chunk1, chunk2, ... chunk8000
3. 클라이언트는 청크를 받아서 순서를 플레이 시켜야한다.
4. 각 청크들을 하나로 인코딩하는게 아니라 128kbps, 256kbps, 512kbps, 1mbps, 2mbps ... 버전을 여러개 만들어놓는다.
   2mbps로 하는 경우는 영상의 화질이 좋을 것이고, 128kbps는 보다 화질이 좋지 않을 것이다. 하지만, 128kbps는 느린속도나가도 된다.
5. 각각에 청크에 각각에 맞는 URL링크가 걸려있다. => 이런정보들을 모은 것들이 manifest file이다.
6. 사용자가 매트릭스를 보려고 클릭하게 되면, 스트리밍이 되는 것이 아니라, manifest file을 보내준다.
7. manifest file은 각 청크 번호와 청크에 해당하는 버전의 URI 테이블이 적혀있다.
8. 그래서 첫 번째 청크에 적혀있는 URL을 가져온다.
9. 128kbps의 버전을 가져온다면 화질이 안좋을 것이다. 
10. 클라이언트에는 DASH가 구현되어 있어서 받으면서 네트워크 상태를 측정을 한다. 괜찮으면 버전이 좋아지는 것을 가져오다가
    속도가 안나오기 시작하면 낮은 버전을 가져올 것이다.
11. 그래서 같은 영화를 보고 있어도 화질이 좋아졌다가 안좋아졌다가 하는 이유가 DASH가 이용되었기 때문이다.
```

## 문제점

* 유튜브의 사용자 수는 어마어마하게 많다. 유튜브에 서버를 두고 제공하게 되면 문제점이 무엇이 있을까?

  다운되면 끝나버린다. 현실적으로는 다 몰리기 때문에 항상 유튜브 주변에 꽉 막힐 것이다.

  그래서 제일 낮은 버전의 영상을 요청하게 될 것이다.

  그럼 위의 과정을 쓰면안되겟네?

* 첫 번째 방법은 멀티태스트라는 방법이다.

  유니캐스트로 1:1로 통신하는 것이 아닌 복사본 하나만 나가고 알아서 찢어져 보내지게된다. 라우터에서 멀티캐스트를 구현하는데 상당히 어렵다.

* 두 번째 방법은 CDN를 사용하는 것이다.

  한 곳에 몰려있으면 난리난다. 그래서 전 세계 곳곳에 스토리지를 배치하는 것이다.

  사용자가 요청하게되면 유튜브에서 manifest file을 받고, 그 뒤에는 manifeset file을 통해 요청하게 되면 CDN storage로부터 가져온다.

  한 곳에 몰려있던 것이 전세계적으로 퍼져있는 것이다.

  CDN 업체는 인프라 업체들이다. 유튜브 등 컨텐츠 업체들이랑 계약을 맺고 사용자들에게 제공하게 된다.