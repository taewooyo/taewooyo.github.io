---
layout: post
title: "TLS과 인증서 이해하기"
categories: 네트워크
author: bn-tw2020
---
* content
{:toc}


## CA중심으로 움직이는 TSL 및 인증서

* 비대칭 키방식으로 흔히 말하는 `PKI(Public Key Infrastructure` 인 공개 키 기반의 암호화 시스템

  을 이해해야 한다.





## 왜 인증서를 사용하지?

* 네트워크 속에서 많은 패킷들이 오고가고 있다. 네트워크 신뢰성이 보장되지 않는 안전하지 않은 장소, 여러 공격자 존재한다.

* 특성 서버로 요청을 보낼 시 많은 라우터와 스위치를 거치게 된다.

* 그 과정 속에서 누군가 우리의 패킷을 훔쳐 볼 수 있다. 패킷을 훔쳐보는 행위는 비밀번호와 같은 민간한 정보를 제3자에게 제공되는 것이다.

> 네트워크 데이터가 암호화된다면?

* 중간에 공격자가 패킷을 열람해도 데이터가 유출되는 것을 막을 수 있다.

* 현재 가장 많이 쓰이는 암호화 방식이 SSL/TLS이다. 이 방식은 `인증서`라는 일종의 서명을 사용한다.

* 인증서를 통해 `너가 신뢰할 수 있는 놈이냐?` 라는 것을 확인하게 된다.

* 인증서가 신뢰할 수 있다는 검증 작업을 거치게 되면 데이터 암호화 작업이 수행된다. 그 과정에서 SSL 보안 통신이라고 불린다.


## 보안 연결 과정

* 서버와 클라이언트 간 보안 연결은 크게 2단계로 나뉜다.

* 첫 번째, 클라이언트의 CA를 통해 서버 인증서가 신뢰 가능한지 확인한다.

  `너가 신뢰할 수 있는 놈이냐?` 라는 것을 `인증서`를 통해 검증한다.

* 두 번째, 보안 연결 수립을 한다. 서버-클라이언트 간에 생성된 랜덤 값을 통해 대칭 키를 생성하고, 이를 통해 네트워크 암호화해 전송한다.

* 결국 인증서를 통한 신뢰 검증이 완료되어야만 보안 연결 수립을 할 수 있다.


## 인증서의 구조

* 신뢰할수 있는 기관이 몇 군데 존재한다. 그 기관들이 최상위 인증 기관이라고 Root CA라는 인증서를 발급하는 기관이다.

  Verisign, Geotrust 등의 회사가 최상위 인증 기관으로 분류되고 있다.

* Sectigo CA를 예로 들면, CA는 고유한 비밀 키를 가지고 있고 ,이에 대응하는 공개 키를 전 세계에 배포한다.

  사람들은 암묵적으로 이 기관을 신용할 수 있음을 약속하게 되고 배포된 Sectigo의 공개 키로 복호화가 가능한 데이터는 

  Sectigo의 비밀 키로 암호화되었기 때문에 신용할 수 있는 데이터가 된다.

* 일반적으로 신뢰 가능하다고 여겨지는 기관의 공개 키는 컴퓨터에 이미 설치되어 있다.

  MacOS는 키체인에 존재하고, 웹 브라우저인 파이어폭스, 크롬 등에도 공개 키가 내장되어있다.


## 인증서의 동작 방식

* 신뢰할 수 있는지 검증하기 위해서 인증서라는 파일에는 다양한 내용이 존재한다.

> 인증서의 구조

*  인증서의 소유자 이름, 인증서 소유자의 공개 키, 인증서의 유효 기간, 고유한 UID, 

   인증서의 기타 모든 값을 해시화한 값, 인증서의 모든 값을 해시화한 값을 암호화한 값이 인증서에 기록된다.

### Geotrust, Google CA(2계층)

* 인증서는 주로 **계층 구조**로 이루어진다. 보통 3계층을 가지고 있다.

  최상위에 위치한 인증서는 Root인증서이며, 모든 사람들이 신뢰하기로 약속한 기관이다. 예시로는 Geotrust 등의 기관에서 발행한 인증서이다.

  이런 인증서는 일반적으로 웹 브라우저 등에 미리 내장되어 있으며, 해당 인증서에 대응하는 공개 키 또한 인증서 내부에 포함되어있다.

<img width="516" alt="스크린샷 2021-09-25 오후 10 06 35" src="https://user-images.githubusercontent.com/66770613/134772647-9fb2c8c6-2dbe-486b-9fc9-5961a2efa377.png">  

```
1. Root 인증서의 주인은 Geotrust가 되고, 자신의 인증서를 만들고 싶은 Google CA회사는 Root에게 요청한다.
2. Google CA회사의 인증서를 만들려고 하는데, 인증서 내용물을 줄테니 해시화한 값을 Geotrust 비밀 키로 암호화해달라고 요청한다.
3. Geostrust 공개 키는 사람들이 모두 가지고 있고, 공개 키로 복호화되는 데이터는 신뢰할 수 있는 데이터임을 한다.
4. 사람들이 Google CA 인증서를 받은 뒤, Google CA 인증서 내부의 암호화된 해시 값을 Geotrust 공개 키를 이용해 복호화했다고 하면,
   Google CA의 인증서의 내용물에 대한 해시 값을, Geotrust가 비밀 키로 암호화 해준것이니, Google CA를 신뢰할 수 있는 것이다.
```

* 위의 원리는 `Chain of Trust` 이다.

> 인증서의 내용물을 해시 값한 후, 비밀 키로 암호화하는 이유는?

<img width="830" alt="스크린샷 2021-09-25 오후 10 43 14" src="https://user-images.githubusercontent.com/66770613/134773655-6f59050b-f9e9-4df2-b49e-f5ed02180b5d.png">  

* Root CA의 공개 키로 Google CA 인증서의 암호화된 해시 값을 복호화가 되면, Chain of Trust에 의해 신뢰됬다고 생각한다.

* Root CA의 공개 키로 복호화한 해시 값과 인증서에 있는 내용물을 다시 해시 값과 비교 시 다르다면,

  Google CA 인증서가 누군가에 의해 `변조` 된 것이다.

* 상위 인증서 기관의 공개 키로 하위 기관의 인증서 해시 값을 복호화 한다는 것은 2가지 효과가 존재

  - Chain of Trust 원리에 의해 하위 인증서가 신뢰할 수 있는지 확인 가능

  - 하위 인증서의 내용물이 변조되었는지를 확인 가능


### Geotrust, Google CA, 개인(3계층)

* 2계층 형태는 기본적인 원리를 파악하는 것이고, 실제로는 3계층형태를 이루게된다.

* 브라우저에서는 Geotrust, Google CA의 인증서는 신뢰할 수 있도록 등록되어 있다.

* 최상위 인증서 기관과 중간 인증서 기관까지는 신뢰할 수 있도록 설정되어있어서 의심할 필요가 없다.

* 중간 인증서 기관은 모두 신뢰할 수 있으며 Root CA 인증서와 구분짓기 위해 ICA(Intermediate CA)라고 부른다.

  위에 설명했던 Google도 신용도 높은 회사로 ICA가 등록되어 있다.

* 3계층에서는 Google과 같은 큰 회사의 ICA가 상위 인증서가 되는 구조이다.

  개인 인증서를 발급받으려면 일반적으로 Root인증서가 아닌 ICA에 인증서의 사인(인증서 내용물 해시값의 암호화)를 요청하게 된다.

<img width="830" alt="스크린샷 2021-09-25 오후 11 05 43" src="https://user-images.githubusercontent.com/66770613/134774310-9cfa2c32-786c-457e-882a-324c88836e19.png">  
  
* 개인이 Google에 인증서 생성을 요청을 보내면 Google CA는 자신의 비밀 키를 이용해 해시값을 암호화하여 인증서에 서명한다.


<img width="830" alt="스크린샷 2021-09-25 오후 11 08 02" src="https://user-images.githubusercontent.com/66770613/134774380-1dea2609-2225-412a-8485-af8751b0e263.png">  

* 2계층 예시처럼, taewoo 인증서에 저장된 암호화된 해시 값은 Google CA로만 복호화가 가능하다.

* Google CA가 신뢰할 수 있는 기관임을 Geotrust 공개 키를 통해 검증했다.

  Google CA 공개 키를 통해 taewoo 인증서에 내장된 암호화된 해시 값의 복호화에 성공했다면, Chain of Trust에 의해 
  
  신뢰할 수 있음을 확인할 수 있다.


## 생각

* Root 인증서를 사인해줄 상위 기관이 없기에, 스스로 보증(Self-signed)한다.

  Geotrust와 같은 Root CA가 발행하는 인증서가 이에 해당한다. 모두가 믿기로 했기에 문제가 되지 않는다.

* ICA라는 중간 기관을 두는 이유가 무엇일까?

  Root CA가 개인 인증서까지 서명하게 되면 직관적이고 쉬운 구조가 될 수 있지만,

  인증을 수행하는 기관의 인증서가 손상되거나 비밀키가 유출될 경우 이를 철회할 수 있도록 ICA를 둔다.

  Root 인증서가 직접 개인 인증서에 서명하는 것에 비해 한 단계 인증 layer가 더 존재하게 되서, 더욱 강력한 보안 체계를 갖는다.

