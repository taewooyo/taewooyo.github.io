---
layout: post
title: "[QnA] 회복"
categories: DB
author: bn-tw2020
---
* content
{:toc}


## 회복 기법

* 회복 기법에 대해 정리합니다.





## 회복의 필요성

* 어떤 트랜잭션 A를 수행하는 도중에 시스템이 다운 됬을 때, A의 수행효과가 디스크의 데이터베이스에 일부 반영되었을 수 있다.

  **어떻게 A의 수행을 취소하여 원자성을 보장할 것인가?**

* 또한 트랜잭션 A가 완료된 직후에 시스템이 다운되면 모든 갱신 효과가 주기억 장치로부터 디스크에 기록되지 않았을 수 있다.

  **어떻게 A의 수행 결과가 데이터베이스에 완전하게 반영되도록 하여 지속성을 보장할 것인가?**

* 디스크의 헤드 등이 고장나서 디스크의 데이터베이스를 접근할 수 없다면 ?


## 회복의 개요

* 여러 응용이 주기억장치 버퍼 내의 동일한 데이터베이스 항목을 갱신한 후에 디스크에 기록함으로써 성능을 향상시키는 것이 중요하다.

* 버퍼의 내용을 디스크에 기록하는 것을 가능하면 최대한 줄이는 것이 일반적이다.

  e.g 버퍼가 꽉 찼을 때 또는 트랜잭션이 완료될 때 버퍼의 내용이 디스크에 기록될 수 있다.

* 트랜잭션이 버퍼에는 갱신 사항을 반영했지만, 버퍼의 내용이 디스크에 기록되기 전에 고장이 발생할 수 있다.

* 고장이 발생하기 전에 트랜잭션이 완료 명령을 수행했다면 회복 모듈은 이 트랜잭션의 갱신 사항을
 
  **재수행(redo)**하여 트랜잭션의 갱신이 지속성을 갖도록 해야한다.

* 고장이 발생하기 전에 트랜잭션이 완료 명령을 수행하지 못했다면 원자성을 보장하기 위해서 이 트랜잭션이 데이터베이스에 반영했을

  가능성이 있는 갱신 사항을 **취소(undo)** 해야 한다.


## 저장 장치의 유형

* 그럼 로그가 저장은 어디에 되는가?

  같은 디스크에 저장되는데 데이터베이스는 망가져도 로그가 살아있다면 회복이 가능합니다.

* 로그 저장되는 하드디스크가 안전성이 더 높습니다. 즉 **안전 저장 장치** 입니다.

  안전 저장 장치는 모든 유형의 고장을 견딜 수 있는 저장 장치를 의미합니다. 
  
  이 말은 2개 이상의 비휘발성 저장 장치가 동시에 고장날 가능성이 매우 낮으므로 비휘발성 저장 장치에

  2 개 이상의 사본을 중복해서 저장함으로써 안전 저장 장치를 구현합니다.


## 고장의 유형

> 재해적 고장

* 디스크가 손상을 입어서 데이터베이스르 읽을 수 없는 고장

* 재해적 고장으로부터의 회복은 데이터베이스를 백업해 놓은 자기테이프를 기반으로 한다.

> 비재해적 고장

* 그 이외의 고장이다.

  대부분 회복 알고리즘들은 비재해적 고장에 적용됩니다.

* **로그를 기반으로 한 즉시 갱신, 로그를 기반으로 한 지연 갱신, 그림자 페이징 등 여러 알고리즘이 존재합니다.

* 대부분의 상용 DBMS에서 로그를 기반으로 한 즉시 갱신 방식을 사용합니다.


## 즉시 갱신 기법

* 즉시 갱신에서는 트랜잭션이 데이터베이스를 갱신한 사항이 주기억 장치의 버퍼에 유지되다가

  트랜잭션이 완료되기 전이라도 디스크의 데이터베이스에 기록될 수 있습니다.

* 데이터베이스에는 완료된 트랜잭션의 수행 결과뿐만 아니라 철회된 트랜잭션의 수행 결과도 반영될 수 있습니다.

* 트랜잭션의 원자성과 지속성을 보장하기 위해 DBMS는 **로그** 라고 부르는 특별한 파일을 유지합니다.

* 데이터베이스의 항목에 영향을 미치는 모든 트랜잭션의 연산들에 대해서 **로그 레코드**를 기록합니다.

* 각 로그 레코드는 **로그 순서 번호**로 식별됩니다.


## 지연 갱신 기법

* 지연갱신 기법은 트랜잭션이 부분 완료 상태에 이르기까지 발생한 모든 변경 내용을 로그 파일에만 저장합니다.

  데이터베이스에는 커밋이 발생할 때까지 저장을 지연하는 기법입니다.

* 회복 과정에서 undo가 필요 없다는 점이 특징이며 이를 통해 원자성을 보장할 수 있습니다.

<img width="219" alt="스크린샷 2021-08-20 오후 7 37 30" src="https://user-images.githubusercontent.com/66770613/130221253-64d1a2de-eae6-4f6c-b6ad-bd1effeea7ea.png">  


## Checkpoint 기법

* 체크포인트 회복 기법은 이전은 신경쓰지 않고,

  체크포인트 이후만 즉시 갱신 또는 지연갱신을 수행합니다.

* 가장 최근 체크포인트 지점을 찾아 그 시점 이후의 로그만을 회복 대상으로 합니다.

* 회복 시 로그 파일의 정보를 모두 검사해야 하며, 이미 반영된 변경에 대해서 불필요한 redo 연산을 수행해야 하는 로그 기반 회복 기법의 문제점 해결이 가능합니다.


## 그림자 페이징 기법(Shadow Paging)

* 그림자 페이징 회복 기법은 트랜잭션이 실행되는 동안 현재 페이지 테이블과 그림자 페이지 테이블 2개의 페이지 테이블을 유지하고 관리하는 회복 기법입니다.

* 데이터베이스를 일정 크기의 블록인 페이지 단위로 유지하고, 로그를 기록하지 않습니다.

* 그림자 페이징 회복 기법의 장점은 로그 레코드를 유지할 필요가 없으며 장애 이후 회복 처리가 불필요합니다.